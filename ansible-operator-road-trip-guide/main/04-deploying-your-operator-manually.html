<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Running v0.0.1 :: Ansible Operator Road Trip Guide</title>
    <link rel="canonical" href="https://atarazana.github.io/ansible-operator-road-trip-guide/ansible-operator-road-trip-guide/main/04-deploying-your-operator-manually.html">
    <link rel="prev" href="03-building-your-1st-operator.html">
    <link rel="next" href="05-running-your-operator-locally.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="https://atarazana.github.io/ansible-operator-road-trip-guide">Ansible Operator Road Trip Guide</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
        <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://developers.redhat.com/ebooks/" target="_blank">Books</a>
        <a class="navbar-item" href="https://developers.redhat.com/cheatsheets/" target="_blank">Cheat Sheets</a>
        <a class="navbar-item" href="https://developers.redhat.com/events/" target="_blank">Upcoming Events</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://redhat-scholars.github.io/kubernetes-tutorial/" target="_blank">Kubernetes</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/istio-tutorial/" target="_blank">Istio</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/quarkus-tutorial/" target="_blank">Quarkus</a>
            <a class="navbar-item" href="https://redhat-developer-demos.github.io/knative-tutorial/" target="_blank">Knative</a>
            <a class="navbar-item" href="https://redhat-scholars.github.io/tekton-tutorial/" target="_blank">Tekton</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ansible-operator-road-trip-guide" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Ansible Operator Road Trip</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup-tools.html">Setup Tools</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup-tools.html#resources">Resources</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup-tools.html#prerequisite">Prerequisites</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-setup-project.html">Setup Project</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup-project.html#login-to-registry">Login to registry</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup-project.html#define-envvars">Define environment variables</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup-project.html#create-project-folder">Create the operator project</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-setup-project.html#setup-python-venv">Setup a Python virtual environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-building-your-1st-operator.html">Building your 1st operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-building-your-1st-operator.html#setup-environment">Set up the environment</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-deploying-your-operator-manually.html">Deploy your operator manually</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="04-deploying-your-operator-manually.html">XYZ</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-running-your-operator-locally.html">Running your operator locally</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-running-your-operator-locally.html">XYZ</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-deploying-your-operator-using-olm.html">Deploy your operator with the Operator Lifecycle Manager</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-deploying-your-operator-using-olm.html">XYZ</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="07-evolving-your-operator.html">Evolving your operator</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="07-evolving-your-operator.html">XYZ</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Ansible Operator Road Trip</span>
    <span class="version">main</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Ansible Operator Road Trip</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Ansible Operator Road Trip</a></li>
    <li><a href="04-deploying-your-operator-manually.html">Deploy your operator manually</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/atarazana/ansible-operator-road-trip-guide/edit/main/documentation/modules/ROOT/pages/04-deploying-your-operator-manually.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Running v0.0.1</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Before we run our code we need to have a Kubernetes cluster. Let’s create one.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
No worries, if you already have one is fine no need to create a new one. But make sure you&#8217;re <code>cluster-admin</code> or can request help from someone who is.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minikube start</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">😄  minikube v1.12.3 on Darwin 10.15.2
✨  Automatically selected the docker driver. Other choices: hyperkit, virtualbox
👍  Starting control plane node minikube in cluster minikube
🔥  Creating docker container (CPUs=2, Memory=3892MB) ...
🐳  Preparing Kubernetes v1.18.3 on Docker 19.03.8 ...
🔎  Verifying Kubernetes components...
🌟  Enabled addons: default-storageclass, storage-provisioner
🏄  Done! kubectl is now configured to use "minikube"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check minikube is fine.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Run this command several times&#8230;&#8203; sometimes you could get status <code>NotReady</code> while the node is starting.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get node</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME       STATUS   ROLES    AGE   VERSION
minikube   Ready    master   26m   v1.18.3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Before running the operator, the CRD must be registered within the Kubernetes apiserver:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">make install</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now it’s time to deploy our operator as you would with any other kubernetes <code>Deployment</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-as-a-normal-deployment"><a class="anchor" href="#running-as-a-normal-deployment"></a>Running v0.0.1 as a normal deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s go a step further and run the operator as a pod. But wait, before we do that we need an image, right? No worries there’s a target for that in the makefile.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Have a look to the <code>Makefile</code> targets and try to understand what they do.
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">make docker-build</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to push the image to the registry. Be sure you’re logged in before start swearing!</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
Don’t forget to go to your registry and make the image public!
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">make docker-push</code></pre>
</div>
</div>
<div class="paragraph">
<p>It’s time to deploy the operator! Run this target:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">make deploy</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should expect an output like this:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">...
/usr/local/bin/kustomize build config/default | kubectl apply -f -
namespace/minerva-operator-system created
customresourcedefinition.apiextensions.k8s.io/appdefinitions.minerva.atarazana.com configured
role.rbac.authorization.k8s.io/minerva-operator-leader-election-role created
clusterrole.rbac.authorization.k8s.io/minerva-operator-manager-role created
clusterrole.rbac.authorization.k8s.io/minerva-operator-proxy-role created
clusterrole.rbac.authorization.k8s.io/minerva-operator-metrics-reader created
rolebinding.rbac.authorization.k8s.io/minerva-operator-leader-election-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/minerva-operator-manager-rolebinding created
clusterrolebinding.rbac.authorization.k8s.io/minerva-operator-proxy-rolebinding created
service/minerva-operator-controller-manager-metrics-service created
deployment.apps/minerva-operator-controller-manager created</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Did you noticed the objects created, including the namespace, <code>minerva-operator-system</code>?
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="checking-out-the-deployment"><a class="anchor" href="#checking-out-the-deployment"></a>Checking out the deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s check if there’s a <code>Deployment</code> in the proper namespace</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get deploy --all-namespaces | grep ${OPERATOR_NAME}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If everything is fine you should see our <code>minerva-operator-controller-manager</code> deployment in namespace <code>minerva-operator-system</code>, something like this:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">minerva-operator-system   minerva-operator-controller-manager   1/1     1            1           6m8s</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-the-1st-cr"><a class="anchor" href="#create-the-1st-cr"></a>Create the 1st instance of our CR</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We want to test our code, this means we have to create an object of the type expected by our operator <code>AppDefinition</code> in our case. We have deployed our operator in a given namespace, so, either we change context to that namespace or we create our <code>CR</code> directly in that namespace. We’ll do the latter:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Don’t forget to load the environment if in a different terminal!
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -n ${PROJECT_NAME} -f ./config/samples/minerva_v1_appdefinition.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The error output should look like this one.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">The appdefinition "appdefinition-sample" is invalid: spec.size: Required value</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open the file <code>./config/samples/minerva_v1_appdefinition.yaml</code> and change it to resemble this one.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Try <code>size: -1</code> you should get this error: <em>The appdefinition ``appdefinition-sample'' is invalid: spec.size: Invalid value: 0: spec.size in body should be greater than or equal to 0</em>
</td>
</tr>
</table>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: minerva.atarazana/v1
kind: AppDefinition
metadata:
  name: appdefinition-sample
spec:
  # Add fields here
  size: 2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Try again, now with a proper value.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f ./config/samples/minerva_v1_appdefinition.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you should see this output.</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">appdefinition.minerva.atarazana.com/appdefinition-sample created</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you run the next command and you get the Memcached pods along with the operator pod you&#8217;re fine; so, pat yourself!</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get pod -n ${PROJECT_NAME}</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                                                   READY   STATUS    RESTARTS   AGE
appdefinition-sample-bf69d6cdf-drjt8                   1/1     Running   0          62s
appdefinition-sample-bf69d6cdf-hjndh                   1/1     Running   0          62s
minerva-operator-controller-manager-66cc7987b5-jr7cz   2/2     Running   0          9m48s</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-building-your-1st-operator.html" class="query-params-link">Building your 1st operator</a></span>
  <span class="next"><a href="05-running-your-operator-locally.html" class="query-params-link">Running your operator locally</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
